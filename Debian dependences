#!/bin/bash

# Update and install dependencies
echo "Updating package list..."
sudo apt-get update -y

# Install essential dependencies
echo "Installing required dependencies..."
sudo apt-get install -y wget curl gnupg software-properties-common lsb-release apt-transport-https ca-certificates

# Run dpkg --configure -a to fix the interrupted installation
echo "Running 'sudo dpkg --configure -a' to fix interrupted dpkg process..."
sudo dpkg --configure -a

# Check and fix broken dependencies
echo "Running 'sudo apt-get install -f' to fix broken dependencies..."
sudo apt-get install -f -y

# Update package lists to ensure everything is up-to-date
echo "Running 'sudo apt-get update -y' to update package lists..."
sudo apt-get update -y

# Optional: Upgrade packages if required
# echo "Upgrading packages..."
# sudo apt-get upgrade -y

# Check and confirm if dpkg is in a clean state
echo "Checking if dpkg is in a clean state..."
dpkg --audit || echo "No broken packages detected."

# Print the status of dpkg
echo "dpkg status after fix:"
dpkg --list

# Install Java 11
echo "Installing Java 11..."
sudo apt-get install -y openjdk-11-jdk
echo "Java Installation Complete."
java -version

# Install Jenkins (Add Jenkins repository and install)
# Setting up Jenkins repository for Ubuntu 20.04 LTS (Focal Fossa) instead of Jammy
echo "Setting up Jenkins repository..."
 sudo wget -O /usr/share/keyrings/jenkins-keyring.asc \
    https://pkg.jenkins.io/debian/jenkins.io-2023.key
echo "deb [signed-by=/usr/share/keyrings/jenkins-keyring.asc]" \
    https://pkg.jenkins.io/debian binary/ | sudo tee \
    /etc/apt/sources.list.d/jenkins.list > /dev/null

# Fix the Jenkins repository by using a supported version (focal)
echo "Fixing Jenkins repository URL..."
sudo sed -i 's|http://pkg.jenkins.io/debian jammy|http://pkg.jenkins.io/debian focal|g' /etc/apt/sources.list.d/jenkins.list

# Now, run apt-get update to refresh the repositories
echo "Running apt-get update for system support..."
sudo apt-get update -y

# Update package list again after adding Jenkins repo
echo "Updating package list again..."
sudo apt-get update -y

# Install Jenkins
echo "Installing Jenkins..."
sudo apt-get install -y jenkins
echo "Jenkins Installation Complete."

# Start Jenkins
echo "Starting Jenkins..."
sudo systemctl start jenkins

# Check Jenkins status
echo "Checking Jenkins status..."
sudo systemctl status jenkins

# Enable Jenkins to start on boot
echo "Enabling Jenkins to start on boot..."
sudo systemctl enable jenkins

# Final Jenkins status check
echo "Final Jenkins status check..."
sudo systemctl status jenkins

# Verify the installation of Java and Jenkins
echo "Verifying Java and Jenkins installations..."
java -version
echo "Jenkins is running on port 8080"


