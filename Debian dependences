#!/bin/bash

# Update and install dependencies
echo "Updating package list..."
sudo apt-get update -y

# Install essential dependencies
echo "Installing required dependencies..."
sudo apt-get install -y wget curl gnupg software-properties-common lsb-release apt-transport-https ca-certificates

# Run dpkg --configure -a to fix the interrupted installation
echo "Running 'sudo dpkg --configure -a' to fix interrupted dpkg process..."
sudo dpkg --configure -a

# Check if there are any broken dependencies
echo "Running 'sudo apt-get install -f' to fix broken dependencies..."
sudo apt-get install -f -y

# Update the package list to ensure everything is up-to-date
echo "Running 'sudo apt-get update -y' to update package lists..."
sudo apt-get update -y

# Reboot the system if needed
echo "Rebooting the system to apply changes..."
sudo reboot

# Install Java 11
echo "Installing Java 11..."
sudo apt-get install -y openjdk-11-jdk
echo "Java Installation Complete."
java -version

# Install Jenkins (Add Jenkins repository and install)
echo "Setting up Jenkins repository..."
wget -q -O - https://pkg.jenkins.io/jenkins.io.key | sudo tee /etc/apt/trusted.gpg.d/jenkins.asc
echo "deb http://pkg.jenkins.io/debian/ $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/jenkins.list

# Update package list again after adding Jenkins repo
echo "Updating package list again..."
sudo apt-get update -y

# Install Jenkins
echo "Installing Jenkins..."
sudo apt-get install -y jenkins
echo "Jenkins Installation Complete."

# Start Jenkins
echo "Starting Jenkins..."
sudo systemctl start jenkins

# Check Jenkins status
echo "Checking Jenkins status..."
sudo systemctl status jenkins

# Enable Jenkins to start on boot
echo "Enabling Jenkins to start on boot..."
sudo systemctl enable jenkins

# Check the status of Jenkins after enabling
echo "Final Jenkins status check..."
sudo systemctl status jenkins

# Verify the installation of Java and Jenkins
echo "Verifying Java and Jenkins installations..."
java -version
echo "Jenkins is running on port 8080"
